{% extends "base.html" %}


{% block content %}
<div class="row">
    <div class="box">
        <div class="box-title">
            <h2>{{post.subject}}</h2>
            <div class="text-muted post-date pull-right"><i class="fa fa-clock-o" aria-hidden="true"></i>{{post.created.strftime("%b %d, %Y")}}</div>
        </div>
        <div class="box-content">
            <div class="row">
                <div class="col-10">
                    <div class="post-content">
                        <pre class="post-content">{{post.content | safe }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="post-buttons">
        <div class="btn-group">
            <button class="btn btn-white" name="edit-post" data-id="{{post.key.id()}}"><i class="fa fa-pencil" aria-hidden="true"></i> Edit</button>
            <button class="btn btn-white" name="delete-post" data-id="{{post.key.id()}}"><i class="fa fa-trash-o" aria-hidden="true"></i> Delete</button>
        </div>
        <div class="btn-group">
            <button class="btn btn-white"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like</button>
            <button class="btn btn-white"><i class="fa fa-thumbs-o-down" aria-hidden="true"></i> Unlike</button>
        </div>
    </div>
</div>
<div class="row">
    <!-- <div class="col-12"> -->
    <div class="box-title">
        <h2>Comments:</h2>
    </div>
    <div class="box-content">
            {% for comment in comments %}
                {{ comment.render() | safe }}
            {% endfor %}
        <div class="row">
            <div class="comment-body">
                <form role="form" class="form-inline" method="post" name="comment-form">
                    <textarea class="form-control" name="comment" placeholder="Write a comment..."></textarea>
                    <!-- <button class="btn btn-primary pull-right" type="submit"><i class="fa fa-commenting-o" aria-hidden="true"></i> Post Comment</button> -->
                </form>
            </div>
        </div>
        <div class="row"></div>
    </div>
</div>


{% endblock %}






{% block tail_script %}
<script>

    /*
     * Get the comment text area and add a keydown event listner to it.
     */
    const commentTextArea = document.querySelector('textarea');
    console.log(commentTextArea);

    const commentForm = document.querySelector('form');
    console.log(commentForm);

    commentTextArea.addEventListener('keydown', onTextAreaKeyDown, false);

    function onTextAreaKeyDown(e) {

        // Post the comment if the Enter key has been pressed.
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            console.log("Enter key pressed!");
            commentForm.submit();
        }
    }

    /*
     * Get the delete post button and add a click event listner to it.
     */
    const deletePostBtn = document.querySelector('button[name=delete-post]');
    console.log(deletePostBtn);
    deletePostBtn.addEventListener('click', onDeletePost, false);

    // Delete the post
    function onDeletePost(e) {
        console.log(e.target);
        console.log(this.dataset);
        const postId = this.dataset.id;
        console.log(postId);

        const path = '/' + postId + '/delete';
        console.log(path);

        post(path, {}, 'POST');
    }

    /*
     * Get the edit post button and add a click event listner to it.
     */
    const editPostBtn = document.querySelector('button[name=edit-post]');
    console.log(editPostBtn);
    editPostBtn.addEventListener('click', onEditPost, false);

    function onEditPost(e) {
        console.log(e.target);
        console.log(this.dataset);
        const postId = this.dataset.id;
        console.log(postId);

        const path = '/' + postId + '/edit';
        console.log(path);

        post(path, {}, 'GET');
    }

    /*
     * Get the delete comment buttons and add a click event listner to each.
     */
    const deleteCommentBtns = document.querySelectorAll('button[name=delete-comment]');
    // console.log(deleteCommentBtns);

    deleteCommentBtns.forEach(button => button.addEventListener('click', onDeleteComment));

    function onDeleteComment(e) {
        const commentId = this.dataset.id;

        const path = '/comment/' + commentId + '/delete';
        console.log(path);

        post(path, {}, 'POST');
    }

    /*
     * Get the edit comment buttons and add a click event listner to each.
     */
    const editCommentBtns = document.querySelectorAll('button[name=edit-comment]');
    editCommentBtns.forEach(button => button.addEventListener('click', onEditComment));


    function onEditComment(e) {
        const commentId = this.dataset.id;

        // Get the corresponding textarea for this.
        const forms = document.querySelectorAll('form[name=comment-edit-form]');
        console.log(forms);
        // convert from NodeList to Array
        const formArray = Array.from(forms);
        const form = formArray.filter(f => (f.dataset.id === commentId));

        // console.log(form);
        console.log(form[0]);
        form[0].style.display = "block";
        console.log(form[0].style);
        const path = '/comment/' + commentId + '/edit';
        console.log(path);
    }

    const cancelButtons = document.querySelectorAll('button[name=comment-edit-cancel]');
    console.log(cancelButtons);

    cancelButtons.forEach(button => button.addEventListener('click', onCancelCommentEdit));

    function onCancelCommentEdit(e) {
        // hide the text area.
        console.log('cancel button clicked');
        console.log(e.target.parentNode);
        const formNode = e.target.parentNode;
        // clear out the text area on the form.
        textarea = formNode.querySelector('textarea');
        textarea.value = "";
        formNode.style.display = "none";
    }


    /*
     * Function to send a GET or POST request to the specified path.
     */
    function post(path, params, method) {
        method = method || "post"; // Set method to post by default if not specified.

        var form = document.createElement("form");
        form.setAttribute("method", method);
        form.setAttribute("action", path);

        for(var key in params) {
            if(params.hasOwnProperty(key)) {
                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", key);
                hiddenField.setAttribute("value", params[key]);

                form.appendChild(hiddenField);
             }
        }

        document.body.appendChild(form);
        form.submit();
}

</script>
{% endblock tail_script %}